<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>言葉 Kotoba — Anime Quotes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Syne:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --ink: #0c0c0c;
      --paper: #f5f0e8;
      --accent: #c0392b;
      --accent-dim: rgba(192, 57, 43, 0.12);
      --muted: #6b6560;
      --line: rgba(245, 240, 232, 0.1);
      --surface: #161616;
      --overlay: rgba(12, 12, 12, 0.88);
    }

    [data-theme="light"] {
      --ink: #f5f0e8;
      --paper: #1a1714;
      --muted: #8a8480;
      --line: rgba(26, 23, 20, 0.12);
      --surface: #ede8df;
      --overlay: rgba(245, 240, 232, 0.92);
    }

    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      background-color: var(--ink);
      color: var(--paper);
      font-family: 'Syne', sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s ease, color 0.3s ease;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
      opacity: 0.4;
    }

    .loading-bar {
      position: fixed;
      top: 0;
      left: 0;
      height: 2px;
      background: var(--accent);
      width: 0%;
      z-index: 200;
      transition: none;
    }

    .loading-bar.running {
      width: 75%;
      transition: width 0.5s ease;
    }

    .loading-bar.done {
      width: 100%;
      transition: width 0.15s ease;
    }

    header {
      padding: 1.5rem 3rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--line);
      position: relative;
      z-index: 10;
      gap: 1rem;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .logo-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: var(--paper);
      line-height: 1;
    }

    .logo-sub {
      font-size: 0.6rem;
      font-weight: 500;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .icon-btn {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      font-size: 1rem;
      flex-shrink: 0;
      user-select: none;
    }

    .icon-btn:hover {
      color: var(--paper);
      border-color: rgba(245, 240, 232, 0.3);
    }

    .icon-btn.active {
      color: var(--accent);
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .fav-count {
      font-size: 0.6rem;
      font-weight: 700;
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4rem 3rem;
      position: relative;
      z-index: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }

    main::-webkit-scrollbar { width: 3px; }
    main::-webkit-scrollbar-track { background: transparent; }
    main::-webkit-scrollbar-thumb { background: var(--line); }

    .quote-stage {
      max-width: 820px;
      width: 100%;
      animation: fadeUp 0.5s ease forwards;
    }

    .quote-eyebrow {
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      min-height: 1.2rem;
    }

    .quote-eyebrow::after {
      content: '';
      display: block;
      width: 60px;
      height: 1px;
      background: var(--line);
    }

    .qotd-badge {
      background: var(--accent);
      color: #fff;
      font-size: 0.52rem;
      letter-spacing: 0.15em;
      padding: 0.18rem 0.5rem;
      font-weight: 700;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .qotd-badge.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .quote-mark {
      font-family: 'Playfair Display', serif;
      font-size: 5rem;
      line-height: 0.75;
      color: var(--accent);
      display: block;
      margin-bottom: 1.25rem;
      user-select: none;
    }

    .quote-text {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.4rem, 3vw, 2.3rem);
      line-height: 1.55;
      font-weight: 400;
      color: var(--paper);
      letter-spacing: 0.01em;
      min-height: 4rem;
    }

    .quote-meta {
      margin-top: 2rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
      min-height: 2.5rem;
    }

    .meta-divider {
      width: 36px;
      height: 1px;
      background: var(--accent);
      flex-shrink: 0;
    }

    .meta-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .character-name {
      font-size: 0.82rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--paper);
      min-height: 1rem;
    }

    .anime-name {
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.06em;
      font-style: italic;
      font-family: 'Playfair Display', serif;
      min-height: 0.9rem;
    }

    .actions {
      margin-top: 3rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .btn-next {
      background: var(--paper);
      color: var(--ink);
      border: none;
      padding: 0.9rem 2.2rem;
      font-family: 'Syne', sans-serif;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: color 0.25s ease;
      flex-shrink: 0;
    }

    .btn-next::after {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--accent);
      transform: translateX(-101%);
      transition: transform 0.28s ease;
      z-index: 0;
    }

    .btn-next span {
      position: relative;
      z-index: 1;
    }

    .btn-next:hover::after {
      transform: translateX(0);
    }

    .btn-next:hover {
      color: #fff;
    }

    .btn-next:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--line);
      padding: 0.9rem 1.4rem;
      font-family: 'Syne', sans-serif;
      font-size: 0.72rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: color 0.2s ease, border-color 0.2s ease;
      flex-shrink: 0;
    }

    .btn-ghost:hover {
      color: var(--paper);
      border-color: rgba(245, 240, 232, 0.3);
    }

    .btn-ghost.saved {
      color: var(--accent);
      border-color: var(--accent);
    }

    .btn-ghost.copied {
      color: #5cb85c;
      border-color: #5cb85c;
    }

    .keyboard-hint {
      font-size: 0.58rem;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
    }

    .keyboard-hint kbd {
      background: var(--surface);
      border: 1px solid var(--line);
      padding: 0.15rem 0.4rem;
      font-family: 'Syne', sans-serif;
      font-size: 0.56rem;
      color: var(--muted);
    }

    .error-msg {
      font-size: 0.68rem;
      color: var(--muted);
      letter-spacing: 0.04em;
      margin-top: 1.25rem;
      display: none;
      opacity: 0.8;
    }

    .error-msg.visible {
      display: block;
    }

    footer {
      padding: 1.25rem 3rem;
      border-top: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
      flex-shrink: 0;
      gap: 1rem;
    }

    .footer-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .footer-text {
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .footer-counter {
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    .footer-counter span {
      color: var(--accent);
      font-weight: 700;
    }

    .footer-api {
      font-size: 0.6rem;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .footer-api a {
      color: var(--muted);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .footer-api a:hover {
      color: var(--paper);
    }

    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .drawer-overlay.visible {
      opacity: 1;
      pointer-events: all;
    }

    .favorites-drawer {
      position: fixed;
      top: 0;
      right: -100%;
      width: 400px;
      max-width: 100vw;
      height: 100vh;
      background: var(--surface);
      border-left: 1px solid var(--line);
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: right 0.32s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .favorites-drawer.open {
      right: 0;
    }

    .drawer-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .drawer-title {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--paper);
    }

    .drawer-close {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      padding: 0.2rem;
      transition: color 0.2s ease;
    }

    .drawer-close:hover {
      color: var(--paper);
    }

    .drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 2rem;
    }

    .drawer-body::-webkit-scrollbar { width: 3px; }
    .drawer-body::-webkit-scrollbar-track { background: transparent; }
    .drawer-body::-webkit-scrollbar-thumb { background: var(--line); }

    .favorites-empty {
      text-align: center;
      color: var(--muted);
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      margin-top: 3rem;
      line-height: 2;
    }

    .fav-item {
      border-bottom: 1px solid var(--line);
      padding: 1.25rem 0;
      position: relative;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .fav-item:last-child { border-bottom: none; }
    .fav-item:hover { opacity: 0.75; }

    .fav-quote {
      font-family: 'Playfair Display', serif;
      font-size: 0.88rem;
      line-height: 1.6;
      color: var(--paper);
      margin-bottom: 0.5rem;
      padding-right: 1.5rem;
    }

    .fav-meta {
      font-size: 0.62rem;
      letter-spacing: 0.1em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .fav-remove {
      position: absolute;
      top: 1.25rem;
      right: 0;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0.2rem;
      transition: color 0.2s ease;
      line-height: 1;
    }

    .fav-remove:hover { color: var(--accent); }

    .drawer-footer {
      padding: 1rem 2rem;
      border-top: 1px solid var(--line);
      flex-shrink: 0;
    }

    .drawer-clear {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      padding: 0.6rem 1rem;
      font-family: 'Syne', sans-serif;
      font-size: 0.62rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      width: 100%;
      transition: color 0.2s ease, border-color 0.2s ease;
    }

    .drawer-clear:hover {
      color: var(--accent);
      border-color: var(--accent);
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(1rem);
      background: var(--surface);
      border: 1px solid var(--line);
      color: var(--paper);
      font-size: 0.7rem;
      font-family: 'Syne', sans-serif;
      letter-spacing: 0.08em;
      padding: 0.75rem 1.5rem;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.2s ease, transform 0.2s ease;
      white-space: nowrap;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.ok { border-color: #5cb85c; color: #5cb85c; }
    .toast.fail { border-color: var(--accent); color: var(--accent); }

    @media (max-width: 768px) {
      header {
        padding: 1.25rem 1.5rem;
      }

      main {
        padding: 3rem 1.5rem;
        align-items: flex-start;
      }

      .quote-mark { font-size: 3.5rem; }

      .keyboard-hint { display: none; }

      footer {
        padding: 1rem 1.5rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .footer-left { gap: 1rem; }
    }

    @media (max-width: 480px) {
      .actions {
        flex-wrap: wrap;
      }

      .btn-next { flex: 1; text-align: center; }
      .btn-ghost { flex: 1; text-align: center; }
    }
  </style>
</head>
<body>

  <div class="loading-bar" id="loadingBar"></div>
  <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

  <aside class="favorites-drawer" id="favDrawer">
    <div class="drawer-header">
      <span class="drawer-title">Saved Quotes</span>
      <button class="drawer-close" onclick="closeDrawer()">✕</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
    <div class="drawer-footer">
      <button class="drawer-clear" onclick="clearFavorites()">Clear all</button>
    </div>
  </aside>

  <header>
    <div class="logo">
      <span class="logo-text">言葉 Kotoba</span>
      <span class="logo-sub">Anime Quote Archive</span>
    </div>
    <div class="header-controls">
      <button class="icon-btn" id="apiBtn" onclick="checkApi()" title="Check API status">⚡</button>
      <button class="icon-btn" id="qotdBtn" onclick="loadQotd()" title="Quote of the Day">☀</button>
      <button class="icon-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle theme">◐</button>
      <button class="icon-btn" id="favBtn" onclick="openDrawer()" title="Saved quotes">
        <span class="fav-count" id="favCount">♡</span>
      </button>
    </div>
  </header>

  <main>
    <div class="quote-stage">
      <div class="quote-eyebrow">
        <span id="eyebrowLabel">—</span>
        <span class="qotd-badge" id="qotdBadge">Today's Pick</span>
      </div>
      <span class="quote-mark" aria-hidden="true">"</span>
      <p class="quote-text" id="quoteText"></p>
      <div class="quote-meta" id="quoteMeta">
        <div class="meta-divider"></div>
        <div class="meta-text">
          <span class="character-name" id="characterName"></span>
          <span class="anime-name" id="animeName"></span>
        </div>
      </div>
      <p class="error-msg" id="errorMsg">API unavailable — showing a local quote instead.</p>
      <div class="actions">
        <button class="btn-next" id="nextBtn" onclick="loadQuote()">
          <span>Next Quote</span>
        </button>
        <button class="btn-ghost" id="saveBtn" onclick="toggleFavorite()">Save</button>
        <button class="btn-ghost" id="copyBtn" onclick="copyQuote()">Copy</button>
        <span class="keyboard-hint" aria-hidden="true">
          <kbd>Space</kbd><kbd>→</kbd> next &nbsp; <kbd>S</kbd> save
        </span>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-left">
      <span class="footer-text">Kotoba — Words that stayed</span>
      <span class="footer-counter">Quote <span id="quoteCounter">—</span></span>
    </div>
    <span class="footer-api">Powered by <a href="https://animechan.io" target="_blank" rel="noopener">AnimeChan</a></span>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    const localQuotes = [
      { quote: "The world is not beautiful, therefore it is.", character: "Kino", anime: "Kino's Journey" },
      { quote: "Power is not will, it is the phenomenon of physically making things happen.", character: "Madara Uchiha", anime: "Naruto Shippuden" },
      { quote: "Whatever you lose, you'll find it again. But what you throw away you'll never get back.", character: "Himura Kenshin", anime: "Rurouni Kenshin" },
      { quote: "If you don't take risks, you can't create a future.", character: "Monkey D. Luffy", anime: "One Piece" },
      { quote: "Loneliness is peaceful, but there will be no one to share the peace with.", character: "Lain Iwakura", anime: "Serial Experiments Lain" },
      { quote: "People's lives don't end when they die. It ends when they lose faith.", character: "Itachi Uchiha", anime: "Naruto" },
      { quote: "The only thing we're allowed to do is believe that we won't regret the choice we made.", character: "Levi Ackerman", anime: "Attack on Titan" },
      { quote: "A dropout will beat a genius through hard work.", character: "Rock Lee", anime: "Naruto" },
      { quote: "If you don't share someone's pain, you can never understand them.", character: "Nagato", anime: "Naruto Shippuden" },
      { quote: "Even if I lose this feeling, I'm sure I'll just fall in love with you all over again.", character: "Syaoran Li", anime: "Cardcaptor Sakura" },
    ];

    let quoteCount = 0;
    let busy = false;
    let current = { quote: '', character: '', anime: '' };
    let recentQuotes = [];

    function bar(state) {
      const el = document.getElementById('loadingBar');
      el.className = 'loading-bar';
      if (state === 'start') {
        requestAnimationFrame(() => el.classList.add('running'));
      }
      if (state === 'done') {
        el.classList.add('done');
        setTimeout(() => el.className = 'loading-bar', 300);
      }
    }

    function render(quote, character, anime) {
      current = { quote, character, anime };
      document.getElementById('quoteText').textContent = quote;
      document.getElementById('characterName').textContent = character;
      document.getElementById('animeName').textContent = anime;
      updateSaveBtn();
    }

    function swap(callback) {
      const text = document.getElementById('quoteText');
      const meta = document.getElementById('quoteMeta');

      text.style.transition = 'opacity 0.25s ease, transform 0.25s ease';
      meta.style.transition = 'opacity 0.25s ease, transform 0.25s ease';
      text.style.opacity = '0';
      text.style.transform = 'translateY(8px)';
      meta.style.opacity = '0';
      meta.style.transform = 'translateY(8px)';

      setTimeout(() => {
        callback();
        text.style.opacity = '1';
        text.style.transform = 'translateY(0)';
        meta.style.opacity = '1';
        meta.style.transform = 'translateY(0)';
      }, 250);
    }

    function pickFreshLocal() {
      const unused = localQuotes.filter(q => !recentQuotes.includes(q.quote));
      const pool = unused.length > 0 ? unused : localQuotes;
      const pick = pool[Math.floor(Math.random() * pool.length)];
      recentQuotes.push(pick.quote);
      if (recentQuotes.length > 5) recentQuotes.shift();
      return pick;
    }

    async function loadQuote() {
      if (busy) return;
      busy = true;

      const btn = document.getElementById('nextBtn');
      const err = document.getElementById('errorMsg');
      btn.disabled = true;
      err.classList.remove('visible');
      setQotd(false);
      bar('start');

      let data = null;
      let usedFallback = false;

      try {
        const res = await fetch('/api/quote');
        if (!res.ok) throw new Error('api');
        const json = await res.json();
        if (json.error || !json.quote) throw new Error('bad data');

        if (recentQuotes.includes(json.quote)) {
          const retry = await fetch('/api/quote');
          const retryJson = await retry.json();
          data = (!retryJson.error && retryJson.quote) ? retryJson : json;
        } else {
          data = json;
        }

        recentQuotes.push(data.quote);
        if (recentQuotes.length > 10) recentQuotes.shift();
      } catch {
        data = pickFreshLocal();
        usedFallback = true;
      }

      quoteCount++;
      bar('done');

      swap(() => {
        render(data.quote, data.character, data.anime);
        document.getElementById('eyebrowLabel').textContent = `Series #${quoteCount}`;
        document.getElementById('quoteCounter').textContent = String(quoteCount).padStart(3, '0');
        if (usedFallback) err.classList.add('visible');
      });

      setTimeout(() => {
        btn.disabled = false;
        busy = false;
      }, 320);
    }

    function setQotd(on) {
      document.getElementById('qotdBadge').classList.toggle('visible', on);
      document.getElementById('qotdBtn').classList.toggle('active', on);
    }

    function loadQotd() {
      const today = new Date().toISOString().slice(0, 10);
      const stored = localStorage.getItem('kotoba_qotd');

      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (parsed.date === today) {
            swap(() => {
              render(parsed.quote, parsed.character, parsed.anime);
              document.getElementById('eyebrowLabel').textContent = 'Quote of the Day';
              setQotd(true);
            });
            return;
          }
        } catch {}
      }

      const idx = dateHash(today) % localQuotes.length;
      const fallbackPick = localQuotes[idx];

      fetch('/api/quote')
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          const q = (data && !data.error && data.quote) ? data : fallbackPick;
          localStorage.setItem('kotoba_qotd', JSON.stringify({ date: today, ...q }));
          swap(() => {
            render(q.quote, q.character, q.anime);
            document.getElementById('eyebrowLabel').textContent = 'Quote of the Day';
            setQotd(true);
          });
        })
        .catch(() => {
          localStorage.setItem('kotoba_qotd', JSON.stringify({ date: today, ...fallbackPick }));
          swap(() => {
            render(fallbackPick.quote, fallbackPick.character, fallbackPick.anime);
            document.getElementById('eyebrowLabel').textContent = 'Quote of the Day';
            setQotd(true);
          });
        });
    }

    function dateHash(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = Math.imul(31, h) + str.charCodeAt(i) | 0;
      }
      return Math.abs(h);
    }

    function getFavs() {
      try { return JSON.parse(localStorage.getItem('kotoba_favs') || '[]'); }
      catch { return []; }
    }

    function saveFavs(list) {
      localStorage.setItem('kotoba_favs', JSON.stringify(list));
    }

    function isSaved() {
      return getFavs().some(f => f.quote === current.quote);
    }

    function toggleFavorite() {
      let list = getFavs();
      if (isSaved()) {
        list = list.filter(f => f.quote !== current.quote);
      } else {
        list.unshift({ ...current, at: Date.now() });
      }
      saveFavs(list);
      updateSaveBtn();
      renderDrawer();
    }

    function updateSaveBtn() {
      const btn = document.getElementById('saveBtn');
      const countEl = document.getElementById('favCount');
      const saved = isSaved();
      const count = getFavs().length;

      btn.textContent = saved ? 'Saved ♥' : 'Save';
      btn.classList.toggle('saved', saved);
      countEl.textContent = count > 0 ? `♥ ${count}` : '♡';
      document.getElementById('favBtn').classList.toggle('active', count > 0);
    }

    function openDrawer() {
      renderDrawer();
      document.getElementById('favDrawer').classList.add('open');
      document.getElementById('drawerOverlay').classList.add('visible');
      document.body.style.overflow = 'hidden';
    }

    function closeDrawer() {
      document.getElementById('favDrawer').classList.remove('open');
      document.getElementById('drawerOverlay').classList.remove('visible');
      document.body.style.overflow = '';
    }

    function renderDrawer() {
      const body = document.getElementById('drawerBody');
      const list = getFavs();
      if (list.length === 0) {
        body.innerHTML = '<p class="favorites-empty">No saved quotes yet.<br>Hit Save on any quote<br>to keep it here.</p>';
        return;
      }
      body.innerHTML = list.map((item, i) => `
        <div class="fav-item" onclick="loadFav(${i})">
          <p class="fav-quote">"${item.quote}"</p>
          <p class="fav-meta">${item.character} — ${item.anime}</p>
          <button class="fav-remove" onclick="removeFav(event,${i})">✕</button>
        </div>
      `).join('');
    }

    function loadFav(i) {
      const item = getFavs()[i];
      if (!item) return;
      closeDrawer();
      swap(() => {
        render(item.quote, item.character, item.anime);
        document.getElementById('eyebrowLabel').textContent = 'From your saved quotes';
        setQotd(false);
      });
    }

    function removeFav(e, i) {
      e.stopPropagation();
      const list = getFavs();
      list.splice(i, 1);
      saveFavs(list);
      renderDrawer();
      updateSaveBtn();
    }

    function clearFavorites() {
      saveFavs([]);
      renderDrawer();
      updateSaveBtn();
    }

    function copyQuote() {
      const btn = document.getElementById('copyBtn');
      const text = `"${current.quote}" — ${current.character} (${current.anime})`;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied ✓';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
      }).catch(() => {
        btn.textContent = 'Failed';
        setTimeout(() => btn.textContent = 'Copy', 2000);
      });
    }

    function showToast(msg, type) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = 'toast show ' + type;
      clearTimeout(el._timer);
      el._timer = setTimeout(() => el.className = 'toast', 3000);
    }

    async function checkApi() {
      const btn = document.getElementById('apiBtn');
      btn.style.opacity = '0.5';
      btn.style.pointerEvents = 'none';
      try {
        const start = Date.now();
        const res = await fetch('/api/quote');
        const ms = Date.now() - start;
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        if (data.error || !data.quote) throw new Error('bad response');
        showToast(`API online — ${ms}ms`, 'ok');
      } catch (err) {
        showToast('API offline — using local quotes', 'fail');
      } finally {
        btn.style.opacity = '';
        btn.style.pointerEvents = '';
      }
    }

    function toggleTheme() {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('kotoba_theme', next);
    }

    document.addEventListener('keydown', (e) => {
      if (['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key === ' ' || e.key === 'ArrowRight') { e.preventDefault(); loadQuote(); }
      if (e.key === 's' || e.key === 'S') toggleFavorite();
      if (e.key === 'Escape') closeDrawer();
      if (e.key === 'd' || e.key === 'D') loadQotd();
    });

    const savedTheme = localStorage.getItem('kotoba_theme');
    if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

    updateSaveBtn();
    loadQuote();
  </script>
</body>
</html>
